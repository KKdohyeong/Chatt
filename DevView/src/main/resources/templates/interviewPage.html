<!-- src/main/resources/templates/interviewPage.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Interview Page</title>
    <style>
        body{font-family:system-ui,sans-serif;margin:0;padding:32px}
        #startPanel{margin-bottom:28px}
        #chatPanel{max-width:740px}
        #messages{height:60vh;overflow-y:auto;display:flex;flex-direction:column;gap:10px;
            border:1px solid #ddd;border-radius:6px;padding:18px;background:#fafafa}
        .msg{max-width:80%;padding:10px 14px;border-radius:18px;font-size:14px;line-height:1.45}
        .ai{align-self:flex-start;background:#fff;border:1px solid #e6e6e6}
        .user{align-self:flex-end;background:#007aff;color:#fff}
        #answerInput{width:100%;box-sizing:border-box;padding:9px;border-radius:6px}
        #noMoreMsg{color:#d00;font-weight:700;margin-top:14px}
        button{cursor:pointer}
    </style>
</head>

<body>
<h2>인터뷰 페이지</h2>

<div id="startPanel">
    <label>
        분야 선택:
        <select id="fieldSelect">
            <option value="">-- 분야 선택 --</option>
            <option th:each="f : ${fields}"
                    th:value="${f.name}"
                    th:text="${f.name}"></option>
        </select>
    </label>
    <button id="startBtn">인터뷰 시작</button>
</div>

<div id="chatPanel" style="display:none">
    <div id="messages"></div>

    <div id="answerPanel" style="margin-top:14px">
        <textarea id="answerInput" rows="3" placeholder="Shift+Enter 는 줄바꿈"></textarea><br>
        <button id="sendBtn">전송</button>
    </div>

    <div id="noMoreMsg" style="display:none">더 이상 질문이 없습니다!</div>
</div>

<script>
    const startPanel  = document.getElementById('startPanel');
    const chatPanel   = document.getElementById('chatPanel');
    const answerPanel = document.getElementById('answerPanel');
    const noMoreMsg   = document.getElementById('noMoreMsg');
    const messages    = document.getElementById('messages');
    const answerInput = document.getElementById('answerInput');

    let interviewId = null;

    document.getElementById('startBtn').addEventListener('click', startInterview);
    document.getElementById('sendBtn') .addEventListener('click', sendAnswer);
    answerInput.addEventListener('keydown', e=>{
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendAnswer(); }
    });

    async function startInterview(){
        const field=document.getElementById('fieldSelect').value;
        if(!field){ alert('분야를 선택하세요.'); return; }

        const res=await fetch('/api/interviews',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({field})
        });
        if(!res.ok){ alert('인터뷰 시작 실패('+res.status+')'); return; }

        const json=await res.json();
        console.log('createInterview ▶', json);

        /* SuccessResponse.result → SingleResult.data.interviewId */
        interviewId =
            json?.result?.data?.interviewId      // 현재 백엔드 구조
            ?? json?.result?.data?.id               // 혹시 id 로 바뀔 경우 대비
            ?? json?.result?.result?.id;            // 예전 방어

        if(!interviewId){
            alert('응답에서 인터뷰 ID를 찾지 못했습니다.');
            return;
        }

        startPanel.style.display='none';
        chatPanel .style.display='block';

        await fetchNextQuestion();
    }

    async function fetchNextQuestion(){
        const res=await fetch(`/api/interviews/${interviewId}/next-question`);
        if(!res.ok){ alert('질문 로드 실패('+res.status+')'); return; }

        const json=await res.json();
        if(json.noMore){
            answerPanel.style.display='none'; noMoreMsg.style.display='block';
            return;
        }
        appendMsg('ai', json.content);
        answerPanel.style.display='block';
    }

    async function sendAnswer(){
        const text=answerInput.value.trim();
        if(!text){ alert('답변을 입력해주세요'); return; }

        appendMsg('user', text);
        answerInput.value='';

        const res=await fetch(`/api/interviews/${interviewId}/answer`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({content:text})
        });
        if(!res.ok){ alert('답변 전송 실패('+res.status+')'); return; }

        const json=await res.json();
        if(json.followUp){
            appendMsg('ai', json.followUp);
        }else if(json.noMore){
            answerPanel.style.display='none'; noMoreMsg.style.display='block';
        }
    }

    function appendMsg(sender, msg){
        const div=document.createElement('div');
        div.className=`msg ${sender==='ai'?'ai':'user'}`;
        div.textContent=msg;
        messages.appendChild(div);
        messages.scrollTop=messages.scrollHeight;
    }
</script>
</body>
</html>
